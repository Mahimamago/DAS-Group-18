---
title: "Code"
author: "Mahima Mago"
date: "2023-03-10"
output:
  pdf_document:
    number_sections: yes
fig_caption : yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
library(knitr)
library(tidyverse)
library(dplyr)
library(kableExtra)
library(MASS)
library(ggplot2)
library(sjPlot)
library(stats) 
library(jtools)
library(ggpubr)
library(GGally)
library(gridExtra)
library(AER)
```

```{r reading dataset, include=FALSE}
#Reading in the data
animal_shelter<-read.csv("dataset18.csv")
#Summary of data
head(animal_shelter)
glimpse(animal_shelter)
```

```{r additinal code}

#Data transformation for EDA

animal_shelter$animal_type <- as.factor(animal_shelter$animal_type)
levels(animal_shelter$chip_status) <- c("BIRD", "DOG","CAT","WILDLIFE","LIVESTOCK")
animal_shelter$intake_type <- as.factor(animal_shelter$intake_type)
animal_shelter$outcome_type <- as.factor(animal_shelter$outcome_type)
animal_shelter$chip_status <- as.factor(animal_shelter$chip_status)

```

\newpage

# Introduction {#sec:intro}

# Exploratory Aanlysis {#sec:sub}

Below graph displays the probability density function of the number of days spent by an animal in the shelter.

```{r pdf of number of days animal spends in the shelter, include=TRUE, out.width='70%', fig.align='center', fig.pos='H', warning=FALSE, fig.cap="\\label{fig:dens} Density plot for the Number of days spent in the shelter"}
ggplot(animal_shelter, aes(x = time_at_shelter)) + 
  geom_density(color = "blue")+
  labs(x="Number of days at Shelter", title="Density plot for the number of days at shelter")

```

From Figure \ref{fig:dens}, the variable number of days spent at the shelter appears to have a right skewed distribution. It seems that more number of animals have spent lesser days in the shelter.

## Types of Animals

```{r}
animal_shelter%>%
  group_by(animal_type)%>%
  summarize(Count=length(time_at_shelter),Mean=mean(time_at_shelter),Std_dev=sd(time_at_shelter),
            Min=min(time_at_shelter),
            Median=median(time_at_shelter),Max=max(time_at_shelter))%>%
  kable(caption = '\\label{tab:summ} Summary statistics of Number of days in shelter by Animal type .',
booktabs = TRUE, format = "latex", digits=2) %>%
  kable_styling(font_size = 10, latex_options = "hold_position")

```

Table \ref{tab:summ} displays the summary statistics for the number of days spent in the shelter by types of animals. Here, we can see that most animals admitted to the shelter are dogs and the least are birds and livestock. Again, on an average dogs have stayed the longest in the shelter as they have the largest mean number of days followed by cats and the birds along with livestock left at the same day. 

```{r barchart and boxplot of animal_type and time_in _shelter, include=TRUE, out.width='70%', fig.align='center', fig.pos='H', warning=FALSE, fig.cap="\\label{fig:box} Number of days spent at the shelter by Animal type"}
ggplot(data = animal_shelter, aes(x = animal_type, y = time_at_shelter, fill = animal_type)) +
  geom_boxplot() +
  labs(x = "The number of days spent in the shelter of different animals", y = "The number of days")+ 
  theme(legend.position = "none")
```

Figure \ref{fig:box} displays a boxplot of the number of days spent by the types of animals in the shelter.
The results from here agree with what we have concluded from the Summary statistics earlier. It can also be seen that Dogs and Cats have a lot of outliers.

## Months

```{r factor month,include=FALSE}
animal_shelter$month
factor(animal_shelter$month)
```

```{r Barchart of month and time_in _shelter, include=TRUE,out.width='70%', fig.align='center', fig.pos='H', warning=FALSE, fig.cap="\\label{fig:bar} Number of days spent at the shelter by Month"}

ggplot(data = animal_shelter, mapping = aes(x = factor(month),fill=month))+
  geom_bar(stat="count", width= 0.5) +
  labs(x = "Month", y = "The number of days",
       title = "The number of days spent in the shelter by month") +
  scale_x_discrete(labels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun",
                              "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))
```

Figure \ref{fig:bar} displays the barchart for the number of days spent in the shelter by month. We can see that the shelter accepts the most animals in July and the least animals in February. 

## Year

```{r}

animal_shelter%>%
  group_by(year)%>%
  summarize(Count=length(time_at_shelter),Mean=mean(time_at_shelter),Std_dev=sd(time_at_shelter),
                    Min=min(time_at_shelter),
            Median=median(time_at_shelter),Max=max(time_at_shelter))%>%
  kable(caption = '\\label{tab:summ1} Summary statistics of Number of days in shelter by Year .',
booktabs = TRUE, format = "latex", digits=2) %>%
  kable_styling(font_size = 10, latex_options = "hold_position")
```

Table \ref{tab:summ1} displays the summary statistics for number of days spent in the shelter in the years 2016 and 2017. We can see that a large number of animals were admitted in 2017. But the maximum number of days an animal spent in the shelter is in 2016.

```{r scatter of year and time_in _shelter, include=TRUE, out.width='70%', fig.align='center', fig.pos='H', warning=FALSE, fig.cap="\\label{fig:col} Number of days spent at the shelter by Year"}

animal_shelter$year <- as.factor(animal_shelter$year)
ggplot(data = animal_shelter, aes(x = year, y = time_at_shelter, fill = year)) +
  geom_col() +
  labs(x = "The number of days spent in the shelter on different years", y = "The number of days")+ 
  theme(legend.position = "none")
```

Figure \ref{fig:col} displays a barchart for number of days spent in shelter by the year. These results agree with what we concluded through the summary statistics earlier. We can see that the average number of days animals spent in shelter in 2016 is slightly larger than in 2017. But overall they are quite similar. 

## Intake Type

```{r}
animal_shelter%>%
  group_by(intake_type)%>%
  summarize(Count=length(time_at_shelter),Mean=mean(time_at_shelter),Std_dev=sd(time_at_shelter),
                    Min=min(time_at_shelter),
            Median=median(time_at_shelter),Max=max(time_at_shelter))%>%
  kable(caption = '\\label{tab:summ2} Summary statistics of Number of days in shelter by Intake type .',
booktabs = TRUE, format = "latex", digits=2) %>%
  kable_styling(font_size = 10, latex_options = "hold_position")

```

Table \ref{tab:summ2} displays the summary statistics for number of days spent in shelter by intake type. We can see that most of the animals admitted to the shelter were strays. On an average, Confiscated animals spent more number of days in the shelter with the maximum number of days spent in the shelter by an animal which was surrendered by the owner.

```{r Boxplot of intake_type and time_in _shelter, include=TRUE, out.width='70%', fig.align='center', fig.pos='H', warning=FALSE, fig.cap="\\label{fig:box1} Number of days spent at the shelter by Intake type"}

ggplot(data = animal_shelter, aes(x = intake_type, y = time_at_shelter, fill = intake_type)) +
  geom_boxplot() +
  labs(x = "The number of days spent in the shelter of different intake types", y = "The number of days")+ 
  theme(legend.position = "none")
```

Figure \ref{fig:box1} displays a boxplot for number of days spent in the shelter by intake type. These are in line with the conclusions drawn from the summary statistics table. We see in the boxplot that the confiscated animals stayed in shelters the longest and the average number of days spent in shelter for animals abandoned by their owners was slightly lower than for lost animals. 

## Chip Status

```{r}
animal_shelter%>%
  group_by(chip_status)%>%
  summarize(Count=length(time_at_shelter),Mean=mean(time_at_shelter),Std_dev=sd(time_at_shelter),
                    Min=min(time_at_shelter),
            Median=median(time_at_shelter),Max=max(time_at_shelter))%>%
  kable(caption = '\\label{tab:summ3} Summary statistics of Number of days in shelter by Chip Status .',
booktabs = TRUE, format = "latex", digits=2) %>%
  kable_styling(font_size = 10, latex_options = "hold_position")
```

Table \ref{tab:summ3} displays the summary statistics for number of days in shelter by the Chip status. Most animals admitted to the shelter had no chips. 

```{r Scatter plot of chip_status and time_in _shelter, include=TRUE, out.width='70%', fig.align='center', fig.pos='H', warning=FALSE, fig.cap="\\label{fig:scat} Number of days spent at the shelter by Chip Status"}

ggplot(data = animal_shelter, aes(x = chip_status, y = time_at_shelter, fill = chip_status)) +
  geom_point() +
  labs(x = "The number of days spent in the shelter of different chip status", y = "The number of days")+ 
  theme(legend.position = "none")
```

Figure \ref{fig:scat} displays the scatter plot for the number of days spent in shelter by the Chip status. The mean number of days that animals with chips spent in shelter was almost the same as animals that without scanchips, and higher than animals who were not able to be scanned.

## Outcome Type

```{r}
animal_shelter%>%
  group_by(outcome_type)%>%
  summarize(Count=length(time_at_shelter),Mean=mean(time_at_shelter),Std_dev=sd(time_at_shelter),
                    Min=min(time_at_shelter),
            Median=median(time_at_shelter),Max=max(time_at_shelter))%>%
  kable(caption = '\\label{tab:summ4} Summary statistics of Number of days in shelter by Outcome type.',
booktabs = TRUE, format = "latex", digits=2) %>%
  kable_styling(font_size = 10, latex_options = "hold_position")
```

Table \ref{tab:summ4} displays the summary statistics for the number of days by the Outcome type. We can see that most number of animals were adopted but after they spent a fairly long number of days in the shelter. Many animals were euthanized and some were returned to the owner after they spent a few days in the shelter. Very few number of animals died as well.

```{r scatter of outcome_type and time_in _shelter, include=TRUE, out.width='70%', fig.align='center', fig.pos='H', warning=FALSE, fig.cap="\\label{fig:scat1} Number of days spent at the shelter by Outcome Type"}

ggplot(data = animal_shelter, aes(x = outcome_type, y = time_at_shelter, fill = chip_status)) +
  geom_point() +
  labs(x = "The number of days spent in the shelter for different outcome types", y = "The number of days")+ 
  theme(legend.position = "none")
```

Figure \ref{fig:scat1} displays the scatter plot for the number of days spent in shelter by the outcome type. The results here are similar to the ones from the summary statistics table. 

Now, let's fit a generalized linear model to see which factors are significant predictors for the number of days an animal spends in shelter.

# Formal Aanlysis {#sec:sub}

As we need to predict what all factors affect the number of days an animal spends in the shelter by fitting a Generalised Linear Model, the number of days will be our response variable. This variable is actually a counts data, hence the distribution that we would consider first is Poisson distribution.

```{r fit poisson GLM model, include=TRUE}
#Fitting a full GLM using poisson distribution.
pois_model<-glm(time_at_shelter ~ animal_type + month + year + intake_type + outcome_type + chip_status,data = animal_shelter,family="poisson")

summary(pois_model) #Summary
```

From this model, we can see that Animal type is not a significant variable. The p-value for all the types of animal is greater than 0.05. Hence, we can conclude that the animal type does not have a significant effect on the number of days an animal spends in the shelter. We will drop this variable and fit the model again.

```{r fit poisson GLM model without animal type, include=TRUE}
#Fitting the same model, without the variable animal_type.
pois_model2<-glm(time_at_shelter ~ month + year + intake_type + outcome_type + chip_status,data = animal_shelter,family="poisson")

summary(pois_model2)
```

After removing animal type which was not significant, the AIC for the model increased by almost 30 points which is absurd. Both the residual deviance and the AIC are really high for this model. If we check the ratio for Residual deviance to the degrees of freedom for both the models, it is quite higher than 1. This might be due to Overdispersion. We can do some other tests to check for overdispersion.

```{r check the overdispersion by plot, include=TRUE}
ggplot(pois_model, aes(x=log(fitted(pois_model)), y=log((animal_shelter$time_at_shelter-fitted(pois_model))^2)))+
  geom_point(col="red") +
  geom_abline(slope=1, intercept=0, col="blue", size=1) +
  ylab(expression((y-hat(mu))^2)) + xlab(expression(hat(mu)))
```
The above figure does not give us a clear picture for overdispersion. Hence we can use some in-built functions to check for the same.

```{r check for overdispersion through function, include=TRUE}
dispersiontest(pois_model,trafo=1)
```

Here, the estimated value for alpha is much greater than 0. Hence, we can conclude that overdispersion is present. In order to deal with this, instead of fitting a model with poisson distribution, we can fit a model with Negative Binomial distribution.

```{r fit the negative.binomial GLM model, include=TRUE}
#Model fitted using negative binomial distribution and all the variables,
nebi_model1<-glm.nb(time_at_shelter ~ animal_type + month + year + intake_type + outcome_type + chip_status,data = animal_shelter)

nebi_model1 %>%
  summary()
```

From the model, we can see that the AIC has significantly reduced along with the Deviance. On the other hand, there are three variables now that are not significant, animal type, month and year. The p-value for all these variables is greater than 0.05. Hence, we can say we have sufficient evidence to conclude that these variables do not significantly affect the number of days spent in the shelter by animals. We can confirm the significance of variables by the following test first.

```{r determine the significance of the regression coefficients, include=TRUE}
drop1(nebi_model1, test = "F")
```

Now, we can fit our model by removing the insignificant variables.

```{r delete unsignificant coefficient, include=TRUE}
#delete insignificant animal_type and month and year to fit a new Nebi GLM model
  nebi_model2<-glm(time_at_shelter~ intake_type + outcome_type + chip_status, 
                            family = negative.binomial(0.9634), data = animal_shelter)
  
  nebi_model2%>%
    summary()

```

We can see here, that after removing the three variables the AIC and Deviance have increased slightly. But this change is very low and hence acceptable with the change in the degrees of freedom. We can check once again for the significance of the remaining variables through the F-test.

```{r determine the significance of coefficients, include=TRUE}
#determine the significance of the regression coefficients
drop1(nebi_model2, test = "F")
```

From the above test we can conclude that no more variables can be removed from the model here. As with the drop of each variable, the AIC and Deviance are both increasing significantly. 

```{r compare poisson and final negative binomial models at their deviance and AIC, include=TRUE}
c(pois_model2$deviance, pois_model2$aic)
c(nebi_model2$deviance, nebi_model2$aic)
```
When we compare the poisson model fitted earlier with the negative binomial model, we can see that the AIC and Deviance have dropped a lot. Hence, using negative binomial distribution for this model fit was a better option.

Thus, this is our final model now. We now need to check if this model is fulfilling all the assumptions.


```{r check the large deviance, include=TRUE,out.width='70%', fig.align='center', fig.pos='H', warning=FALSE, fig.cap="\\label{fig:res} Plots for Pearson and Deviance residuals"}

resp <- resid(nebi_model2, type = "pearson")
resd <- resid(nebi_model2, type = "deviance")
p1<- ggplot(nebi_model2, aes(sample = resp)) + geom_point(stat = "qq", color = "green") +
  ylab("Pearson residuals")
p2<- ggplot(nebi_model2, aes(sample = resd)) + geom_point(stat = "qq", color = "green") +
  ylab("Deviance residuals")
p3<- ggplot(nebi_model2, aes(x = predict(nebi_model2, type="link"), y =resd))+
  geom_point(col = "green") +
  geom_jitter(width = 10,height = 10, col="green")+
  ylab("Deviance residuals") + xlab("Linear predictor")
grid.arrange(p1, p2, p3, nrow = 1)

```

Figure \ref{fig:res} displays the graphs of residuals from our model. From the first two graphs, we can see that all the points are not following a straight line exactly. Although, in the second graph there is a roughly straight line, In both the graphs, there is an outlier clearly visible. The third graph which is a plot of Deviance against the linear predictor shows no obvious pattern, hence we can say that the assumption of nonlinearity is being followed here.

```{r residuals versus fitted values, include=TRUE,out.width='70%', fig.align='center', fig.pos='H', warning=FALSE, fig.cap="\\label{fig:res2} Plots for Residuals and Standardised Residuals against Fitted values"}

std.res=rstandard(nebi_model2)
p4 = ggplot(nebi_model2, aes(nebi_model2$fitted.values, nebi_model2$residuals)) + 
  labs(x="Fitted values", y="Residuals")+
  geom_point() +
  geom_jitter(width = 10,height = 10)+
  geom_hline(yintercept = 0) +
  geom_smooth(se = FALSE)

p5 = ggplot(nebi_model2, aes(nebi_model2$fitted.values, std.res)) +
  labs(x="Fitted values", y="Standardised residuals")+
  geom_point() +
  geom_jitter(width = 10,height = 10)+
  geom_hline(yintercept = 0) +
  geom_smooth(se = FALSE)

grid.arrange(p4,p5,nrow=1)
```

Figure \ref{fig:res2} displays plots for Residuals and Standardised residuals against Fitted values. From these plots, we can see that most of the points are evenly spread above and below zero, hence indicating zero mean. The variance also appears to be fairly constant.

```{r qq-plot, include=TRUE,out.width='70%', fig.align='center', fig.pos='H', warning=FALSE, fig.cap="\\label{fig:res3} Normal probability plot"}
ggplot(nebi_model2) +
  stat_qq(aes(sample = std.res)) +
  geom_abline()
```

Figure \ref{fig:res3} displays the QQ-Plot for the model. From the plot, we can see that normality assumption is not being followed perfectly, with most of the points lying below the line. 

```{r, include=TRUE,out.width='70%', fig.align='center', fig.pos='H', warning=FALSE, fig.cap="\\label{fig:res4} Cook's distance" }
cookd=cooks.distance(nebi_model2)

ggplot(nebi_model2, aes(seq_along(cookd), cookd))+
  geom_bar(stat="identity", position="identity")+
    xlab("Obs. Number")+
  ylab("Cook's distance")+
  ggtitle("Cook's distance")+
  theme_bw()
    
```

Figure \ref{fig:res4} displays the plot for Cook's distance for all the observations. We can see that there are two points which have really large Cook's distance.

## Outliers 

From the graphs for all the diagnostic checks we saw that there are a number of outliers in our model. We can try fixing this by exluding some of the observations coming as outliers from our data.

```{r deleting outliers, include=TRUE}
animal_shelter2<-animal_shelter %>%
  filter(time_at_shelter<=20)
```

```{r final model4,include=TRUE}
#final nebi model without outliers
nebi_model3<-glm(time_at_shelter~intake_type+outcome_type+chip_status, 
                 family = negative.binomial(0.9634), data = animal_shelter2)

nebi_model3%>%
  summary()
```

```{r significant coefficients,include=TRUE}
#determine the significance of the regression coefficients
drop1(nebi_model3, test = "F")
```

```{R assumption check, include = FALSE}
resp <- resid(nebi_model3, type = "pearson")
resd <- resid(nebi_model3, type = "deviance")
p1<- ggplot(nebi_model3, aes(sample = resp)) + geom_point(stat = "qq", color = "green") +
  ylab("Pearson residuals")
p2<- ggplot(nebi_model3, aes(sample = resd)) + geom_point(stat = "qq", color = "green") +
  ylab("Deviance residuals")
p3<- ggplot(nebi_model3, aes(x = predict(nebi_model3, type="link"), y =resd))+
  geom_point(col = "green") +
  geom_jitter(width = 10,height = 10, col="green")+
  ylab("Deviance residuals") + xlab("Linear predictor")
grid.arrange(p1, p2, p3, nrow = 1)

ggplot(nebi_model3) +
  stat_qq(aes(sample = rstandard(nebi_model3))) +
  geom_abline()
```


